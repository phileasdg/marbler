<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-K13VH578CQ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-K13VH578CQ');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- SEO Meta Tags -->
    <title>Marbler - Interactive Digital Marbling Art Generator</title>
    <meta name="description" content="Create unique, fluid art with Marbler, an interactive digital marbling tool. Drop and comb digital ink to generate beautiful, high-resolution abstract images.">
    <meta name="keywords" content="digital art, marbling, generative art, abstract art, p5.js, creative tool, interactive art, fluid dynamics, art generator">
    <link rel="canonical" href="https://your-website-url.com/"> <!-- Replace with your actual URL -->
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ¨</text></svg>">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-website-url.com/"> <!-- Replace with your actual URL -->
    <meta property="og:title" content="Marbler - Interactive Digital Marbling Art Generator">
    <meta property="og:description" content="Create unique, fluid art with Marbler, an interactive digital marbling tool.">
    <meta property="og:image" content="https://placehold.co/1200x630/4f46e5/ffffff?text=Marbler"> <!-- Replace with a preview image URL -->

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://your-website-url.com/"> <!-- Replace with your actual URL -->
    <meta property="twitter:title" content="Marbler - Interactive Digital Marbling Art Generator">
    <meta property="twitter:description" content="Create unique, fluid art with Marbler, an interactive digital marbling tool.">
    <meta property="twitter:image" content="https://placehold.co/1200x630/4f46e5/ffffff?text=Marbler"> <!-- Replace with a preview image URL -->

    <!-- Tailwind CSS for styling the UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- p5.js library for graphics and interaction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <!-- p5.js SVG library for saving vector graphics -->
    <script src="https://cdn.jsdelivr.net/npm/p5.js-svg@1.5.1/dist/p5.svg.min.js"></script>
    <style>
        /* Custom styles for a clean, artistic gallery feel */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Prevents pull-to-refresh on mobile */
            background: #f8fafc; /* A very light, clean gray */
        }
        #p5-canvas-container {
            border: 1px solid #e2e8f0;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        }
        .control-panel {
            background-color: #ffffff;
        }
        
        /* Custom styled radio buttons for tool selection */
        .tool-selector input[type="radio"] { display: none; }
        .tool-selector label {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: 2px solid #e2e8f0;
        }
        .tool-selector input[type="radio"]:checked + label {
            background-color: #e0e7ff;
            border-color: #a5b4fc;
            color: #312e81;
        }
        .tool-selector label:hover {
            background-color: #f8fafc;
            border-color: #c7d2fe;
        }

        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 5px;
            background: #e2e8f0;
            border-radius: 99px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 18px; height: 18px;
            background: #4f46e5;
            cursor: pointer; border-radius: 50%;
            transition: background 0.2s;
        }
        input[type="range"]::-webkit-slider-thumb:hover { background: #6366f1; }
        
        select, .btn, input[type="number"] {
            border: 1px solid #cbd5e1;
            transition: all 0.2s ease-in-out;
        }
        select:hover, .btn:hover, input[type="number"]:hover {
            border-color: #a5b4fc;
            box-shadow: 0 0 0 2px #e0e7ff;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] {
          -moz-appearance: textfield;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: all 0.3s ease-in-out;
        }
        .modal.hidden .modal-backdrop {
            opacity: 0;
        }
        .modal.hidden .modal-content {
            opacity: 0;
            transform: scale(0.95);
        }
        .color-swatch {
            flex-grow: 1;
            height: 1rem;
            border-radius: 4px;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Marbler",
      "description": "An interactive digital marbling tool to create unique, fluid art by dropping and combing digital ink.",
      "applicationCategory": "MultimediaApplication",
      "operatingSystem": "All",
      "author": {
        "@type": "Person",
        "name": "Phileas Dazeley-Gaist"
      },
      "url": "https://your-website-url.com/" 
    }
    </script>
</head>
<body class="text-gray-800 flex flex-col md:flex-row h-screen overflow-hidden">

    <!-- Mobile Menu Button -->
    <button id="menu-open-button" class="md:hidden fixed top-4 left-4 z-20 p-2 bg-white rounded-full shadow-lg btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>

    <!-- Main Canvas Area -->
    <main class="flex-1 flex items-center justify-center p-4 md:p-8">
        <div id="p5-canvas-container" class="w-full h-full rounded-lg overflow-hidden">
            <!-- p5.js canvas will be inserted here -->
        </div>
    </main>

    <!-- Controls Panel -->
    <div id="control-panel" class="control-panel fixed inset-y-0 left-0 z-40 w-full max-w-sm transform -translate-x-full transition-transform duration-300 ease-in-out md:relative md:max-w-none md:w-80 lg:w-96 md:translate-x-0 md:border-l md:border-gray-200 p-6 flex flex-col">
        <div class="space-y-6 overflow-y-auto pr-4">
            <div class="flex justify-between items-center">
                <div class="space-y-1">
                    <h1 class="text-2xl font-bold text-gray-900">Marbler</h1>
                    <p class="text-sm text-gray-500">Create unique, fluid art.</p>
                </div>
                <div class="flex items-center gap-2">
                     <button id="about-button" class="btn p-2 rounded-full hover:bg-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                    </button>
                    <button id="menu-close-button" class="md:hidden btn p-2 rounded-full hover:bg-gray-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>

            <!-- Mode Section -->
            <div class="space-y-3 pt-4 border-t border-gray-200">
                <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Mode</h2>
                <div class="grid grid-cols-2 gap-2 tool-selector w-full">
                    <input type="radio" name="mode" value="paint" id="mode-paint" checked>
                    <label for="mode-paint" title="Paint" class="flex items-center justify-center gap-2 p-3 rounded-md font-medium text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                        <span>Paint</span>
                    </label>
                    <input type="radio" name="mode" value="navigate" id="mode-navigate">
                    <label for="mode-navigate" title="Navigate" class="flex items-center justify-center gap-2 p-3 rounded-md font-medium text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="5 9 2 12 5 15"></polyline><polyline points="9 5 12 2 15 5"></polyline><polyline points="15 19 12 22 9 19"></polyline><polyline points="19 9 22 12 19 15"></polyline><line x1="2" y1="12" x2="22" y2="12"></line><line x1="12" y1="2" x2="12" y2="22"></line></svg>
                        <span>Navigate</span>
                    </label>
                </div>
            </div>
            
            <div id="paint-controls" class="space-y-6">
                <!-- Tools Section -->
                <div class="space-y-3 pt-4 border-t border-gray-200">
                    <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Tool</h2>
                    <div class="grid grid-cols-3 gap-2 tool-selector w-full">
                        <input type="radio" name="tool" value="ink" id="tool-ink" checked>
                        <label for="tool-ink" title="Ink Drop" class="flex items-center justify-center gap-2 p-3 rounded-md font-medium text-sm">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>
                            <span>Ink</span>
                        </label>
                        
                        <input type="radio" name="tool" value="tine-line" id="tool-tine-line">
                        <label for="tool-tine-line" title="Tine Line" class="flex items-center justify-center gap-2 p-3 rounded-md font-medium text-sm">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            <span>Line</span>
                        </label>
                        
                        <input type="radio" name="tool" value="tine-circle" id="tool-tine-circle">
                        <label for="tool-tine-circle" title="Tine Circle" class="flex items-center justify-center gap-2 p-3 rounded-md font-medium text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>
                            <span>Circle</span>
                        </label>
                    </div>
                </div>

                <!-- Settings Sections -->
                <div id="ink-settings-panel" class="space-y-4 pt-4 border-t border-gray-200">
                    <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Ink Dropper</h2>
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label for="drop-growth-rate" class="text-xs font-medium flex justify-between items-center">
                                <span>Growth Rate</span> 
                                <input type="number" id="drop-growth-rate-value" class="w-16 text-center rounded-md p-1" min="10" max="150" value="50" step="1">
                            </label>
                            <input type="range" id="drop-growth-rate" min="10" max="150" value="50" step="1">
                        </div>
                        <div class="space-y-1">
                            <label for="drop-detail" class="text-xs font-medium flex justify-between items-center">
                                <span>Detail</span> 
                                <input type="number" id="drop-detail-value" class="w-16 text-center rounded-md p-1" min="10" max="10000" value="2000">
                            </label>
                            <input type="range" id="drop-detail" min="10" max="10000" value="2000">
                        </div>
                         <div class="space-y-1">
                            <label for="ink-displacement" class="text-xs font-medium flex justify-between items-center">
                                <span>Displacement</span> 
                                <input type="number" id="ink-displacement-value" class="w-16 text-center rounded-md p-1" min="0.1" max="2" value="1" step="0.1">
                            </label>
                            <input type="range" id="ink-displacement" min="0.1" max="2" value="1" step="0.1">
                        </div>
                        <div class="space-y-1">
                            <label for="ink-trail-spacing" class="text-xs font-medium flex justify-between items-center">
                                <span>Trail Spacing</span> 
                                <input type="number" id="ink-trail-spacing-value" class="w-16 text-center rounded-md p-1" min="5" max="100" value="25" step="1">
                            </label>
                            <input type="range" id="ink-trail-spacing" min="5" max="100" value="25" step="1">
                        </div>
                        <div class="space-y-2">
                             <label class="text-xs font-medium">Color</label>
                            <div class="flex items-center gap-3">
                                <input type="color" id="color-picker" value="#4f46e5" class="w-9 h-9 p-0 border-none bg-transparent rounded-md cursor-pointer appearance-none">
                                <div class="flex-grow">
                                    <label class="flex items-center gap-2 text-sm">
                                        <input type="checkbox" id="random-color" class="accent-indigo-600 w-4 h-4 rounded" checked>
                                        <span>Random</span>
                                    </label>
                                    <select id="color-palette" class="w-full text-xs p-1 rounded-md mt-1 bg-white"></select>
                                    <div id="color-palette-preview" class="flex items-center mt-2 h-4 overflow-hidden w-full space-x-1"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tine-settings-panel" class="hidden space-y-4 pt-4 border-t border-gray-200">
                    <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Tine Tools</h2>
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label for="tine-z" class="text-xs font-medium flex justify-between items-center">
                                <span id="tine-z-label">Displacement Rate</span> 
                                <input type="number" id="tine-z-value" class="w-16 text-center rounded-md p-1" min="0" max="100" value="80" step="0.1">
                            </label>
                            <input type="range" id="tine-z" min="0" max="100" value="80" step="0.1">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-medium">Direction</label>
                            <div id="tine-line-direction" class="grid grid-cols-2 gap-2 tool-selector w-full">
                                <input type="radio" name="tine-line-direction" value="1" id="tine-line-forward" checked>
                                <label for="tine-line-forward" class="text-center p-2 rounded-md text-sm">Forward</label>
                                <input type="radio" name="tine-line-direction" value="-1" id="tine-line-backward">
                                <label for="tine-line-backward" class="text-center p-2 rounded-md text-sm">Backward</label>
                            </div>
                            <div id="tine-circle-direction" class="hidden grid grid-cols-2 gap-2 tool-selector w-full">
                                <input type="radio" name="tine-circle-direction" value="1" id="tine-circle-cw" checked>
                                <label for="tine-circle-cw" class="text-center p-2 rounded-md text-sm">Clockwise</label>
                                <input type="radio" name="tine-circle-direction" value="-1" id="tine-circle-ccw">
                                <label for="tine-circle-ccw" class="text-center p-2 rounded-md text-sm">Counter-CW</label>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label for="tine-c" class="text-xs font-medium flex justify-between items-center">
                                <span>Sharpness</span> 
                                <input type="number" id="tine-c-value" class="w-16 text-center rounded-md p-1" min="1" max="50" value="40" step="0.1">
                            </label>
                            <input type="range" id="tine-c" min="1" max="50" value="40" step="0.1">
                        </div>
                        <div id="tine-circle-radius-container" class="hidden space-y-1">
                            <label for="tine-circle-radius" class="text-xs font-medium flex justify-between items-center">
                                <span>Circle Radius</span> 
                                <input type="number" id="tine-circle-radius-value" class="w-16 text-center rounded-md p-1" min="10" max="300" value="80" step="0.1">
                            </label>
                            <input type="range" id="tine-circle-radius" min="10" max="300" value="80" step="0.1">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="mt-auto pt-6 border-t border-gray-200 space-y-2">
             <h2 class="text-sm font-semibold text-gray-600 uppercase tracking-wider">Actions</h2>
            <div class="grid grid-cols-2 gap-2">
                <button id="save-png" class="btn w-full bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg">Save PNG</button>
                <button id="clear-canvas" class="btn w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">
                    Clear Canvas
                </button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-backdrop absolute inset-0 bg-black/50"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 md:p-8 w-11/12 max-w-lg mx-auto relative">
            <button id="close-modal-button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">About Marbler</h2>
            <div class="text-gray-600 space-y-4">
                <p>This interactive tool was created by Phileas Dazeley-Gaist to bring the concepts from his technical article on mathematical marbling to life. It's a passion project designed for creative exploration.</p>
                <p>The physics engine is based on the foundational work of Aubrey Jaffer.</p>
            </div>
            <div class="mt-6 pt-6 border-t">
                <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wider mb-3">Links & Acknowledgements</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <ul class="space-y-3">
                        <li><a href="https://people.csail.mit.edu/jaffer/Marbling/" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">Aubrey Jaffer's Work</a></li>
                        <li><a href="https://community.wolfram.com/groups/-/m/t/3258063" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">Original Article</a></li>
                    </ul>
                    <ul class="space-y-3">
                        <li><a href="https://phileasdg.github.io/" target="_blank" rel="noopener noreferrer" class="bg-indigo-100 text-indigo-700 font-semibold rounded-full px-3 py-1 inline-block hover:bg-indigo-200">Personal Blog</a></li>
                        <li><a href="https://www.paypal.com/donate/?business=K74DYULZRHZ2J&no_recurring=0&item_name=Buy+me+a+coffee+%3AD&currency_code=USD" target="_blank" rel="noopener noreferrer" class="bg-yellow-100 text-yellow-800 font-semibold rounded-full px-3 py-1 inline-block hover:bg-yellow-200">Buy me a coffee</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tutorial Modal -->
    <div id="tutorial-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-backdrop absolute inset-0 bg-black/50"></div>
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 md:p-8 w-11/12 max-w-lg mx-auto relative">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Welcome to Marbler!</h2>
            <div class="text-gray-600 space-y-4">
                <p>A quick guide to the studio:</p>
                <ul class="list-disc pl-5 space-y-2">
                    <li><strong>Paint Mode:</strong> Use the Ink, Line, and Circle tools to create your art. Click and hold to see effects grow.</li>
                    <li><strong>Navigate Mode:</strong> Click and drag to pan the canvas. Use your scroll wheel to zoom in and out.</li>
                    <li><strong>Save Your Work:</strong> When you're done, save your creation as a PNG file from the Actions panel.</li>
                </ul>
            </div>
            <div class="mt-6 pt-6 border-t flex justify-between items-center">
                <label class="flex items-center gap-2 text-sm text-gray-500">
                    <input type="checkbox" id="hide-tutorial-checkbox" class="accent-indigo-600 w-4 h-4 rounded">
                    <span>Don't show this again</span>
                </label>
                <button id="close-tutorial-button" class="btn bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Get Started</button>
            </div>
        </div>
    </div>

    <script>
        // --- p5.js Sketch ---
        const sketch = (p) => {
            let polygons = [];
            let previewPolygons = [];
            let isActionInProgress = false;
            let isModalOpen = false;
            
            // --- Camera Controls ---
            let camera = { zoom: 1.0, x: 0, y: 0 };
            let panStart = null;

            // --- UI Control Variables ---
            let currentMode = 'paint';
            let currentTool = 'ink';
            let dropGrowthRate = 50, dropDetail = 2000, inkDisplacement = 1, inkTrailSpacing = 25;
            let tineLineSettings = { zRate: 80, c: 40, direction: 1 };
            let tineCircleSettings = { zRate: 80, c: 40, r: 80, direction: 1 };
            let inkColor = '#4f46e5';
            let useRandomColor = true;
            let dragStart = null;
            let lastRandomColor = null;
            let activeDropColor = null;
            let pressStartTime = 0;
            let trailPoints = [];

            const colorPalettes = {
                ocean: ['#03045e', '#023e8a', '#0077b6', '#0096c7', '#00b4d8', '#48cae4', '#90e0ef', '#ade8f4', '#caf0f8', '#7400b8', '#6930c3', '#5e60ce', '#5390d9', '#4ea8de'],
                sunset: ['#4c1d95', '#7c3aed', '#c084fc', '#f87171', '#fb923c', '#fbbf24', '#fde047', '#ff006e', '#ff6d00', '#ff8500', '#ff9100', '#ffc300'],
                forest: ['#081c15', '#1b4332', '#2d6a4f', '#40916c', '#52b788', '#74c69d', '#95d5b2', '#283618', '#606c38', '#dda15e', '#bc6c25', '#fefae0'],
                vibrant: ['#ff6b6b', '#f94144', '#f3722c', '#f8961e', '#f9c74f', '#90be6d', '#43aa8b', '#577590', '#ef476f', '#ffd166', '#06d6a0', '#118ab2', '#073b4c']
            };
            let currentPalette = 'ocean';

            const deepCopyPolygons = (polyArray) => {
                return polyArray.map(poly => new MarblePolygon(poly.vertices.map(v => v.copy()), poly.color));
            };

            class MarblePolygon {
                constructor(vertices, color) { this.vertices = vertices; this.color = color; }
                show(g) { // Accepts a graphics context
                    g.fill(this.color); g.noStroke(); g.beginShape();
                    for (const v of this.vertices) { g.vertex(v.x, v.y); }
                    g.endShape(p.CLOSE);
                }
            }
            
            const drawScene = (g, polys) => {
                g.background('#ffffff');
                for (const poly of polys) {
                    poly.show(g);
                }
            };

            const fitCanvasToContainer = () => {
                const container = document.getElementById('p5-canvas-container');
                p.resizeCanvas(container.offsetWidth, container.offsetHeight);
            };

            const screenToWorld = (screenX, screenY) => {
                return p.createVector(
                    (screenX - camera.x) / camera.zoom,
                    (screenY - camera.y) / camera.zoom
                );
            };

            p.setup = () => {
                const container = document.getElementById('p5-canvas-container');
                const canvas = p.createCanvas(container.offsetWidth, container.offsetHeight);
                canvas.parent(container);
                camera.x = p.width / 2;
                camera.y = p.height / 2;

                // --- Mobile Menu Logic ---
                const controlPanel = document.getElementById('control-panel');
                const openMenuButton = document.getElementById('menu-open-button');
                const closeMenuButton = document.getElementById('menu-close-button');
                const backdrop = document.createElement('div');
                backdrop.className = 'fixed inset-0 bg-black/30 z-30 md:hidden hidden';
                document.body.appendChild(backdrop);

                const openMenu = () => {
                    controlPanel.classList.remove('-translate-x-full');
                    backdrop.classList.remove('hidden');
                };

                const closeMenu = () => {
                    controlPanel.classList.add('-translate-x-full');
                    backdrop.classList.add('hidden');
                };

                openMenuButton.addEventListener('click', openMenu);
                closeMenuButton.addEventListener('click', closeMenu);
                backdrop.addEventListener('click', closeMenu);


                const tineZSlider = document.getElementById('tine-z');
                const tineZValue = document.getElementById('tine-z-value');
                const tineZLabel = document.getElementById('tine-z-label');
                const tineCSlider = document.getElementById('tine-c');
                const tineCValue = document.getElementById('tine-c-value');
                const tineCircleRadiusSlider = document.getElementById('tine-circle-radius');
                const tineCircleRadiusValue = document.getElementById('tine-circle-radius-value');

                const setupSliderBinding = (sliderId, inputId, callback) => {
                    const slider = document.getElementById(sliderId);
                    const input = document.getElementById(inputId);
                    
                    slider.addEventListener('input', (e) => {
                        const val = e.target.value;
                        input.value = val;
                        callback(val);
                    });
                    input.addEventListener('input', (e) => {
                        const val = e.target.value;
                        slider.value = val;
                        callback(val);
                    });
                };

                setupSliderBinding('drop-growth-rate', 'drop-growth-rate-value', val => dropGrowthRate = parseFloat(val));
                setupSliderBinding('drop-detail', 'drop-detail-value', val => dropDetail = parseInt(val, 10));
                setupSliderBinding('ink-displacement', 'ink-displacement-value', val => inkDisplacement = parseFloat(val));
                setupSliderBinding('ink-trail-spacing', 'ink-trail-spacing-value', val => inkTrailSpacing = parseFloat(val));
                
                tineZSlider.addEventListener('input', e => {
                    const val = parseFloat(e.target.value);
                    if (currentTool === 'tine-line') tineLineSettings.zRate = val;
                    else if (currentTool === 'tine-circle') tineCircleSettings.zRate = val;
                    tineZValue.value = val;
                });
                tineZValue.addEventListener('input', e => {
                    const val = parseFloat(e.target.value);
                    if (currentTool === 'tine-line') tineLineSettings.zRate = val;
                    else if (currentTool === 'tine-circle') tineCircleSettings.zRate = val;
                    tineZSlider.value = val;
                });

                tineCSlider.addEventListener('input', e => {
                    const val = parseFloat(e.target.value);
                    if (currentTool === 'tine-line') tineLineSettings.c = val;
                    else if (currentTool === 'tine-circle') tineCircleSettings.c = val;
                    tineCValue.value = val;
                });
                tineCValue.addEventListener('input', e => {
                    const val = parseFloat(e.target.value);
                    if (currentTool === 'tine-line') tineLineSettings.c = val;
                    else if (currentTool === 'tine-circle') tineCircleSettings.c = val;
                    tineCSlider.value = val;
                });

                tineCircleRadiusSlider.addEventListener('input', e => {
                    const val = parseFloat(e.target.value);
                    tineCircleSettings.r = val;
                    tineCircleRadiusValue.value = val;
                });
                tineCircleRadiusValue.addEventListener('input', e => {
                    const val = parseFloat(e.target.value);
                    tineCircleSettings.r = val;
                    tineCircleRadiusSlider.value = val;
                });
                
                document.querySelectorAll('input[name="tine-line-direction"]').forEach(radio => radio.addEventListener('change', e => tineLineSettings.direction = parseInt(e.target.value, 10)));
                document.querySelectorAll('input[name="tine-circle-direction"]').forEach(radio => radio.addEventListener('change', e => tineCircleSettings.direction = parseInt(e.target.value, 10)));

                document.getElementById('color-picker').addEventListener('input', e => inkColor = e.target.value);
                document.getElementById('random-color').addEventListener('change', e => useRandomColor = e.target.checked);
                
                const paletteSelect = document.getElementById('color-palette');
                const palettePreview = document.getElementById('color-palette-preview');
                const updateColorPalettePreview = () => {
                    const selected = paletteSelect.value;
                    palettePreview.innerHTML = '';
                    if (selected === 'random') {
                        const gradient = document.createElement('div');
                        gradient.className = 'w-full h-4 rounded-full';
                        gradient.style.background = 'linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet)';
                        palettePreview.appendChild(gradient);
                    } else {
                        colorPalettes[selected].forEach(color => {
                            const swatch = document.createElement('div');
                            swatch.className = 'color-swatch';
                            swatch.style.backgroundColor = color;
                            palettePreview.appendChild(swatch);
                        });
                    }
                };
                
                paletteSelect.addEventListener('change', e => {
                    currentPalette = e.target.value;
                    updateColorPalettePreview();
                });
                
                // Populate select and initial preview
                const paletteNames = { ocean: "Ocean Blues", sunset: "Sunset Hues", forest: "Forest Greens", vibrant: "Vibrant", random: "Purely Random" };
                Object.keys(paletteNames).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = paletteNames[key];
                    paletteSelect.appendChild(option);
                });
                updateColorPalettePreview();


                document.getElementById('clear-canvas').addEventListener('click', () => { polygons = []; lastRandomColor = null; });
                document.getElementById('save-png').addEventListener('click', () => {
                    const tempGraphics = p.createGraphics(p.width, p.height);
                    tempGraphics.translate(camera.x, camera.y);
                    tempGraphics.scale(camera.zoom);
                    drawScene(tempGraphics, polygons);
                    tempGraphics.save('marbled-ink.png');
                    tempGraphics.remove();
                });
                
                const paintControls = document.getElementById('paint-controls');
                const canvasContainer = document.getElementById('p5-canvas-container');

                document.querySelectorAll('input[name="mode"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        currentMode = e.target.value;
                        paintControls.classList.toggle('hidden', currentMode !== 'paint');
                        canvasContainer.style.cursor = (currentMode === 'navigate') ? 'grab' : 'crosshair';
                    });
                });

                const inkSettingsPanel = document.getElementById('ink-settings-panel');
                const tineSettingsPanel = document.getElementById('tine-settings-panel');
                const tineCircleRadiusContainer = document.getElementById('tine-circle-radius-container');
                const tineLineDirection = document.getElementById('tine-line-direction');
                const tineCircleDirection = document.getElementById('tine-circle-direction');

                document.querySelectorAll('input[name="tool"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        currentTool = e.target.value;
                        const isTine = currentTool.startsWith('tine');
                        inkSettingsPanel.classList.toggle('hidden', isTine);
                        tineSettingsPanel.classList.toggle('hidden', !isTine);
                        tineCircleRadiusContainer.classList.toggle('hidden', currentTool !== 'tine-circle');
                        tineLineDirection.classList.toggle('hidden', currentTool !== 'tine-line');
                        tineCircleDirection.classList.toggle('hidden', currentTool !== 'tine-circle');
                        
                        if (currentTool === 'tine-line') {
                            tineZSlider.value = tineLineSettings.zRate;
                            tineZValue.value = tineLineSettings.zRate;
                            tineCSlider.value = tineLineSettings.c;
                            tineCValue.value = tineLineSettings.c;
                            tineZLabel.textContent = 'Displacement Rate';
                        } else if (currentTool === 'tine-circle') {
                            tineZSlider.value = tineCircleSettings.zRate;
                            tineZValue.value = tineCircleSettings.zRate;
                            tineCSlider.value = tineCircleSettings.c;
                            tineCValue.value = tineCircleSettings.c;
                            tineCircleRadiusSlider.value = tineCircleSettings.r;
                            tineCircleRadiusValue.value = tineCircleSettings.r;
                            tineZLabel.textContent = 'Displacement Rate';
                        }
                    });
                });
                
                // Modal Logic
                const aboutModal = document.getElementById('about-modal');
                const aboutButton = document.getElementById('about-button');
                const closeModalButton = document.getElementById('close-modal-button');
                const aboutModalBackdrop = aboutModal.querySelector('.modal-backdrop');

                const openAboutModal = () => {
                    isModalOpen = true;
                    aboutModal.classList.remove('hidden');
                };
                const closeAboutModal = (e) => {
                    e.stopPropagation();
                    aboutModal.classList.add('hidden');
                    isModalOpen = false;
                };

                aboutButton.addEventListener('click', openAboutModal);
                closeModalButton.addEventListener('click', closeAboutModal);
                aboutModalBackdrop.addEventListener('click', closeAboutModal);

                // Tutorial Modal Logic
                const tutorialModal = document.getElementById('tutorial-modal');
                const closeTutorialButton = document.getElementById('close-tutorial-button');
                const hideTutorialCheckbox = document.getElementById('hide-tutorial-checkbox');

                const openTutorial = () => {
                    isModalOpen = true;
                    tutorialModal.classList.remove('hidden');
                };
                const closeTutorial = (e) => {
                    e.stopPropagation();
                    if (hideTutorialCheckbox.checked) {
                        localStorage.setItem('marbler-hide-tutorial', 'true');
                    }
                    tutorialModal.classList.add('hidden');
                    isModalOpen = false;
                };

                if (localStorage.getItem('marbler-hide-tutorial') !== 'true') {
                    openTutorial();
                }
                closeTutorialButton.addEventListener('click', closeTutorial);
                tutorialModal.querySelector('.modal-backdrop').addEventListener('click', closeTutorial);


                setTimeout(fitCanvasToContainer, 100);
            };

            p.draw = () => {
                p.background('#ffffff');
                p.push();
                p.translate(camera.x, camera.y);
                p.scale(camera.zoom);

                let polysToDraw = isActionInProgress ? previewPolygons : polygons;
                drawScene(p, polysToDraw);
                
                const worldMouse = screenToWorld(p.mouseX, p.mouseY);

                if (currentMode === 'paint' && isActionInProgress) {
                    if (currentTool === 'ink') {
                        let currentPreview = deepCopyPolygons(polygons);
                        for(const drop of trailPoints) {
                            const elapsedTime = p.millis() - drop.startTime;
                            const currentRadius = (elapsedTime / 1000) * dropGrowthRate;
                            currentPreview = addInkToCollection(currentPreview, drop.pos.x, drop.pos.y, currentRadius, drop.color);
                        }
                        previewPolygons = currentPreview;

                    } else if (currentTool === 'tine-line') {
                        const endPoint = screenToWorld(p.mouseX, p.mouseY);
                        const dist = p5.Vector.dist(dragStart.world, endPoint);
                        const dynamicZ = (dist / (p.width / 2)) * tineLineSettings.zRate * tineLineSettings.direction;
                        applyTineLine(dragStart.world, endPoint, dynamicZ, tineLineSettings.c, true);
                    } else if (currentTool === 'tine-circle') {
                        const frameZ = (p.deltaTime / 1000) * tineCircleSettings.zRate * tineCircleSettings.direction;
                        previewPolygons = applyTineCircle(previewPolygons, worldMouse, tineCircleSettings.r, frameZ, tineCircleSettings.c);
                    }
                }
                
                if (currentMode === 'paint' && currentTool === 'tine-circle' && isMouseInCanvas()) {
                    p.noFill(); p.stroke(0, 0, 0, 100); p.strokeWeight(2 / camera.zoom);
                    p.circle(worldMouse.x, worldMouse.y, tineCircleSettings.r * 2);
                }
                p.pop();

                if (currentMode === 'paint' && currentTool === 'tine-line' && dragStart) {
                    p.stroke(0, 0, 0, 100); p.strokeWeight(2);
                    p.line(dragStart.screen.x, dragStart.screen.y, p.mouseX, p.mouseY);
                }
            };
            
            const marbleDisplace = (point, dropCenter, r, displacement) => {
                const pMinusC = p5.Vector.sub(point, dropCenter);
                const magSq = pMinusC.magSq();
                if (magSq === 0) {
                    const randomDir = p5.Vector.fromAngle(p.random(p.TWO_PI));
                    randomDir.setMag(r);
                    return p5.Vector.add(dropCenter, randomDir);
                }
                const displacementFactor = p.sqrt(1 + (displacement * r * r) / magSq);
                pMinusC.mult(displacementFactor);
                return p5.Vector.add(dropCenter, pMinusC);
            };

            const addInkToCollection = (polyCollection, x, y, r, color) => {
                const newDropCenter = p.createVector(x, y);
                let targetPolygons = deepCopyPolygons(polyCollection);

                targetPolygons.forEach(poly => {
                    for (let i = 0; i < poly.vertices.length; i++) {
                        poly.vertices[i] = marbleDisplace(poly.vertices[i], newDropCenter, r, inkDisplacement);
                    }
                });
                
                const newDropVertices = [];
                for (let i = 0; i < dropDetail; i++) {
                    const angle = p.map(i, 0, dropDetail, 0, p.TWO_PI);
                    newDropVertices.push(p.createVector(x + p.cos(angle) * r, y + p.sin(angle) * r));
                }
                
                targetPolygons.push(new MarblePolygon(newDropVertices, color));
                return targetPolygons;
            };
            
            const tineLineDisplace = (point, start, end, z, c) => {
                const M = p5.Vector.sub(end, start);
                if (M.magSq() === 0) return point.copy();
                M.normalize();
                const pMinusB = p5.Vector.sub(point, start);
                const n = p.createVector(-M.y, M.x);
                const dist = p.abs(pMinusB.dot(n));
                if (dist === 0) return point.copy();
                const invertedC = 51 - c;
                const u = p.pow(0.5, 1 / invertedC);
                const magnitude = z * p.pow(u, dist);
                return p5.Vector.add(point, p5.Vector.mult(M, magnitude));
            };

            const applyTineLine = (start, end, z, c, isPreview = false) => {
                if (p5.Vector.dist(start, end) < 1) return;
                const source = isPreview ? polygons : deepCopyPolygons(polygons);
                const target = source.map(poly => 
                    new MarblePolygon(
                        poly.vertices.map(v => tineLineDisplace(v, start, end, z, c)),
                        poly.color
                    )
                );
                if (isPreview) previewPolygons = target;
                else polygons = target;
            };

            const tineCircleDisplace = (point, center, r, z, c) => {
                const pMinusC = p5.Vector.sub(point, center);
                const p_r = pMinusC.mag();
                if (p_r === 0) return point.copy();
                const d = p.abs(p_r - r);
                if (d === 0) return point.copy();
                const invertedC = 51 - c;
                const u = p.pow(0.5, 1 / invertedC);
                const l = z * p.pow(u, d); // arc length
                const angle = l / p_r;
                pMinusC.rotate(angle);
                return p5.Vector.add(center, pMinusC);
            };

            const applyTineCircle = (sourcePolys, center, r, z, c) => {
                 const target = sourcePolys.map(poly => 
                    new MarblePolygon(
                        poly.vertices.map(v => tineCircleDisplace(v, center, r, z, c)),
                        poly.color
                    )
                );
                return target;
            };

            const isMouseInCanvas = () => p.mouseX > 0 && p.mouseX < p.width && p.mouseY > 0 && p.mouseY < p.height;
            
            const getNextColor = () => {
                if (useRandomColor) {
                    let newColor;
                    do {
                        if (currentPalette === 'random') {
                            newColor = p.color(p.random(255), p.random(255), p.random(255));
                        } else {
                            newColor = p.color(p.random(colorPalettes[currentPalette]));
                        }
                    } while (lastRandomColor && newColor.toString() === lastRandomColor.toString());
                    return newColor;
                } else {
                    return p.color(inkColor);
                }
            };
            
            p.mousePressed = () => {
                if (!isMouseInCanvas() || p.mouseButton !== p.LEFT || isModalOpen) return;
                if (currentMode === 'paint') {
                    isActionInProgress = true;
                    pressStartTime = p.millis();
                    dragStart = {
                        world: screenToWorld(p.mouseX, p.mouseY),
                        screen: p.createVector(p.mouseX, p.mouseY)
                    };
                    previewPolygons = deepCopyPolygons(polygons);

                    if (currentTool === 'ink') {
                        trailPoints = [{
                            pos: dragStart.world,
                            startTime: pressStartTime,
                            color: getNextColor()
                        }];
                    }
                } else if (currentMode === 'navigate') {
                    panStart = p.createVector(p.mouseX, p.mouseY);
                    document.getElementById('p5-canvas-container').style.cursor = 'grabbing';
                }
            };
            
            p.mouseDragged = () => {
                if (isModalOpen) return;
                if (panStart) {
                    camera.x += p.mouseX - p.pmouseX;
                    camera.y += p.mouseY - p.pmouseY;
                } else if (isActionInProgress && currentTool === 'ink') {
                    const worldMouse = screenToWorld(p.mouseX, p.mouseY);
                    const lastPoint = trailPoints[trailPoints.length - 1];
                    const dist = p5.Vector.dist(worldMouse, lastPoint.pos);
                    if (dist > inkTrailSpacing) {
                        trailPoints.push({
                            pos: worldMouse,
                            startTime: p.millis(),
                            color: getNextColor()
                        });
                    }
                }
            };

            p.mouseReleased = () => {
                if (isModalOpen) return;
                if (isActionInProgress) {
                    if (currentTool === 'ink') {
                        lastRandomColor = trailPoints[trailPoints.length - 1].color;
                    }
                    polygons = previewPolygons;
                    isActionInProgress = false;
                    dragStart = null;
                    trailPoints = [];
                }
                if (panStart) {
                    panStart = null;
                    if (currentMode === 'navigate') {
                        document.getElementById('p5-canvas-container').style.cursor = 'grab';
                    }
                }
            };

            p.mouseWheel = (event) => {
                if (!isMouseInCanvas() || currentMode !== 'navigate' || isModalOpen) return;
                const zoomFactor = 1.1;
                const mouseWorldBefore = screenToWorld(p.mouseX, p.mouseY);
                if (event.delta < 0) {
                    camera.zoom *= zoomFactor;
                } else {
                    camera.zoom /= zoomFactor;
                }
                const mouseWorldAfter = screenToWorld(p.mouseX, p.mouseY);
                camera.x += (mouseWorldAfter.x - mouseWorldBefore.x) * camera.zoom;
                camera.y += (mouseWorldAfter.y - mouseWorldBefore.y) * camera.zoom;
                return false; // prevent page scrolling
            };
            
            p.windowResized = () => {
                fitCanvasToContainer();
            };
        };
        new p5(sketch);
    </script>
</body>
</html>
